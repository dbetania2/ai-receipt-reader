<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>TicketApp - Subir Recibo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>Sesión iniciada</h1>
    <p>Selecciona un archivo de recibo para procesar y guardar en Google Sheets</p>

    <!-- formulario para subir un archivo -->
    <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" name="image" id="imageInput" accept="image/*" required>
        
        <!-- contenedor de previsualización -->
        <div id="previewContainer">
            <img id="previewImage" src="" alt="Previsualización del recibo" style="display:none;">
        </div>

        <button type="submit">Procesar recibo</button>
    </form>

    <!-- boton que se mostrara despues de procesar -->
    <button id="openSheetBtn" style="display:none;">Abrir hoja de cálculo</button>

    <script>
    // Previsualización de la imagen seleccionada
    const imageInput = document.getElementById("imageInput");
    const previewImage = document.getElementById("previewImage");

    imageInput.addEventListener("change", function() {
        const file = this.files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                previewImage.style.display = "block";
            };
            reader.readAsDataURL(file);
        } else {
            previewImage.src = "";
            previewImage.style.display = "none";
        }
    });

    // Manejo del envío del formulario
    document.getElementById("uploadForm").onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData(this);

        const response = await fetch("/api/process", { method: "POST", body: formData });
        const result = await response.json();

        if(result.spreadsheet_id){
            const btn = document.getElementById("openSheetBtn");
            btn.style.display = "inline-block";
            btn.onclick = () => {
                window.open(`https://docs.google.com/spreadsheets/d/${result.spreadsheet_id}`, "_blank");
            }
            alert(result.message);
        } else {
            alert(result.message);
        }
    };
    </script>
</body>
</html>
